version: '3.9'
services:
  ebytr:
    build: 
      context: reverse-proxy
      args:
        NGINX_CONFIG_FILE: dev.conf
    ports:
      - 3000:3000
      - 3002:3002
    depends_on:
      api:
        condition: service_healthy
      ui:
        condition: service_healthy
    restart: always

  ui:
    build: 
      context: ui
      target: builder
    ports:
      - 3000
      - 3002
    command: yarn vite -c vite.config.docker.ts
    volumes:
      - ./ui:/app
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "lsof", "-t", "-i:3000"]
      interval: 3s
      timeout: 10s
      retries: 5

  api:
    build: api
    ports:
      - 3001
    command: yarn dev
    volumes:
      - ./api:/app
    environment:
      - DB_HOST=db
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "lsof", "-t", "-i:3001"]
      interval: 3s
      timeout: 10s
      retries: 5

  db:
    image: mongo
    ports:
      - 27017
    restart: always
    healthcheck:
      test: ["CMD", "pgrep", "mongod"]
      interval: 3s
      timeout: 10s
      retries: 5
